name: Generate Quarto page from Issue Form
on:
  issues:
    types: [edited, labeled]
jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: write
    if: |
      (github.event.action == 'labeled' &&
       github.event.label.name == 'project_package_tool_submission') ||
      (github.event.action == 'edited' &&
       contains(join(github.event.issue.labels.*.name, ','), 'project_package_tool_submission'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Extract issue data
        id: extract
        uses: issue-ops/parser@v4.2.0
        with:
          body: ${{ github.event.issue.body }}
          issue-form-template: 1-new_package_project_tool_submission.yml
      - name: Create QMD file
        run: |
          RAW_MODEL_NAME="${{ fromJSON(steps.extract.outputs.json).model_name }}"
          SAFE_MODEL_NAME=$(echo "$RAW_MODEL_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[ \t\-]\+/_/g' | tr -cd 'a-z0-9_')
          mkdir -p "packages_projects_tools/$SAFE_MODEL_NAME"
          JSON='${{ steps.extract.outputs.json }}'
          language=$(echo "$JSON" | jq -r '.language[]' | sed 's/^/  - /')
          categories=$(echo "$JSON" | jq -r '.category[]' | sed 's/^/  - /')

          # Map status â†’ colored span, works for string or array
          status_span=$(echo "$JSON" | jq -r '
            def colorize($s):
              if $s == "Bronze" then "<span style=\"color: #893400FF\">Bronze</span>"
              elif $s == "Silver" then "<span style=\"color: #888888FF\">Silver</span>"
              elif $s == "Gold" then "<span style=\"color: #D18B12FF\">Gold</span>"
              else "<span>" + ($s // "Unknown") + "</span>"
              end;

            .status | (if type=="array" then .[] else . end) | colorize(.)
          ')

          # Extract language array
          language=$(echo "$JSON" | jq -r '.language[]' | sed 's/^/  - /')

          # Extract and process language_other
          language_other=$(echo "$JSON" | jq -r '.language_other // ""')

          # Add language_other items if present
          if [ -n "$language_other" ]; then
            # Split on semicolons and add each as a list item
            while IFS=';' read -ra LANGS; do
              for lang in "${LANGS[@]}"; do
                # Trim whitespace
                lang=$(echo "$lang" | xargs)
                if [ -n "$lang" ]; then
                  language=$(printf "%s\n  - %s" "$language" "$lang")
                fi
              done
            done <<< "$language_other"
          fi

          cat > "packages_projects_tools/$SAFE_MODEL_NAME/${SAFE_MODEL_NAME}.qmd" <<EOF
          ---
          title: "${{ fromJSON(steps.extract.outputs.json).model_name }}"
          categories:
          ${categories}
          tool-language:
          ${language}
          author:
            - name: "${{ fromJSON(steps.extract.outputs.json).author }}"
              affiliation:
              orcid:
          status: ${status_span}
          toc: true
          image:
          pub-info:
            abstract: |
              "${{ fromJSON(steps.extract.outputs.json).summary }}"
            links:
            - name: Code
              url: "${{ fromJSON(steps.extract.outputs.json).code }}"
              icon: fa-brands fa-github
            - name: Documentation
              url: "${{ fromJSON(steps.extract.outputs.json).documentation }}"
              icon: fa-solid fa-book
            - name: Paper
              url: "${{ fromJSON(steps.extract.outputs.json).paper }}"
              icon: fa-solid fa-file-contract
            - name: PyPi
              url: "${{ fromJSON(steps.extract.outputs.json).pypi }}"
              icon: fa-solid fa-brands fa-python
            - name: CRAN
              url: "${{ fromJSON(steps.extract.outputs.json).cran }}"
              icon: fa-solid fa-brands fa-r-project
            - name: Website
              url: "${{ fromJSON(steps.extract.outputs.json).website }}"
              icon: fa-solid fa-globe
          ---

          ## Additional Links
          ${{ fromJSON(steps.extract.outputs.json).other_urls }}

          ## Additional Categories
          ${{ fromJSON(steps.extract.outputs.json).category_other }}

          ## Details
          ${{ fromJSON(steps.extract.outputs.json).details }}

          
          <br>

          ## Project status

          **Status: {{< meta status >}}**

          **Rationale:** "${{ fromJSON(steps.extract.outputs.json).status_reason }}"

          EOF
      - name: Commit and open PR
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Add package, tool or project: ${{ fromJSON(steps.extract.outputs.json).model_name }}"
          branch: add-${{ fromJSON(steps.extract.outputs.json).model_name }}
          title: "Add package, tool or project: ${{ fromJSON(steps.extract.outputs.json).model_name }}"
          body: "Auto-generated from issue #${{ github.event.issue.number }}"
          reviewers: Bergam0t
      - name: Save PR URL to environment
        run: echo "PR_URL=${{ steps.create_pr.outputs.pull-request-url }}" >> $GITHUB_ENV
      - name: Comment on the issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const prUrl = process.env.PR_URL;
            const body = `
            ðŸ‘‹ Thanks for your submission!

            A pull request has been automatically opened: ${prUrl}

            A member of the review team will review it soon. ðŸš€
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });
